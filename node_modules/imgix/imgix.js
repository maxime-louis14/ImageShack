// Generated by CoffeeScript 1.8.0
(function() {
  var crypto, generateSignUrl, urlParser;

  urlParser = require('url');

  crypto = require('crypto');

  generateSignUrl = function(token, url) {
    var signvalue, u;
    u = urlParser.parse(url, true, true);
    signvalue = token + u.path;
    u.query.s = crypto.createHash("md5").update(signvalue).digest("hex");
    delete u.search;
    return urlParser.format(u);
  };

  module.exports = function(domain, token, sourceUrl, ops) {
    var signedUrl, u;
    u = urlParser.parse(sourceUrl);
    signedUrl = {
      protocol: 'https',
      host: domain,
      pathname: u.protocol + '//' + u.host + u.pathname,
      query: ops
    };
    if (u.search) {
      signedUrl.pathname += encodeURIComponent(u.search);
    }
    return generateSignUrl(token, urlParser.format(signedUrl));
  };

}).call(this);
